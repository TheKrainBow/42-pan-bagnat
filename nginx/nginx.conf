worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # If upstream proxy sets X-Forwarded-Proto, trust it; otherwise fall back to $scheme
    map $http_x_forwarded_proto $forwarded_proto {
        default $http_x_forwarded_proto;
        ''      $scheme;
    }

    # Toggle HTTPâ†’HTTPS redirect through env (1/true/on enables redirect)
    map "${NGINX_FORCE_HTTPS}" $force_https {
        default 0;
        "0" 0;
        "false" 0;
        "off" 0;
        "1" 1;
        "true" 1;
        "on" 1;
    }

    map "$scheme:$force_https" $redirect_to_https {
        default 0;
        "http:1" 1;
    }

    # Default proxy headers for backend + proxy-service traffic
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-Proto $forwarded_proto;
    proxy_set_header   X-Forwarded-Host  $host;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;

    upstream pan-bagnat-frontend {
        zone pan_bagnat_frontend 64k;
        server pan-bagnat-frontend:3000 resolve;
    }

    upstream pan-bagnat-backend {
        zone pan_bagnat_backend 64k;
        server pan-bagnat-backend:8080 resolve;
    }

    upstream pan-bagnat-proxy-service {
        zone pan_bagnat_proxy_service 64k;
        server pan-bagnat-proxy-service:9090 resolve;
    }

    # ===== Main domain (HTTP) =====
    server {
        listen 80;
        server_name ${HOST_NAME};

        if ($redirect_to_https) {
            return 308 https://$host$request_uri;
        }

        include /etc/nginx/snippets/main-site-locations.conf;
    }

    # ===== Main domain (HTTPS) =====
    server {
        listen 443 ssl http2;
        server_name ${HOST_NAME};

        ssl_certificate     ${NGINX_SSL_CERT};
        ssl_certificate_key ${NGINX_SSL_CERT_KEY};

        include /etc/nginx/snippets/main-site-locations.conf;
    }

    # ===== Wildcard modules (HTTP) =====
    server {
        listen 80;
        server_name modules.${HOST_NAME} *.modules.${HOST_NAME};
        access_log /var/log/nginx/modules_access.log;

        if ($redirect_to_https) {
            return 308 https://$host$request_uri;
        }

        include /etc/nginx/snippets/modules-proxy.conf;
    }

    # ===== Wildcard modules (HTTPS) =====
    server {
        listen 443 ssl http2;
        server_name modules.${HOST_NAME} *.modules.${HOST_NAME};
        access_log /var/log/nginx/modules_access.log;

        ssl_certificate     ${NGINX_SSL_CERT};
        ssl_certificate_key ${NGINX_SSL_CERT_KEY};

        include /etc/nginx/snippets/modules-proxy.conf;
    }
}
